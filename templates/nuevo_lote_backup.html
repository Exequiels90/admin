{% extends "base.html" %}

{% block title %}Nuevo Lote{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">📦 Nuevo Lote</h1>
                <div>
                    <a href="{{ url_for('listar_lotes') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Volver a Lotes
                    </a>
                </div>
            </div>
        </div>
    </div>

    <form method="POST" id="formNuevoLote">
        <!-- Información del Lote -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle text-primary"></i> 
                            Información del Lote
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="numero_lote" class="form-label">Número de Lote</label>
                                <input type="text" class="form-control" id="numero_lote" name="numero_lote" 
                                       value="{{ numero_lote }}" readonly>
                                <div class="form-text">Generado automáticamente</div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="nro_factura" class="form-label">Número de Factura</label>
                                <input type="text" class="form-control" id="nro_factura" name="nro_factura" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="id_proveedor" class="form-label">Proveedor</label>
                                <div class="input-group">
                                    <select class="form-select" id="id_proveedor" name="id_proveedor" required>
                                        <option value="">Seleccionar proveedor...</option>
                                        {% for proveedor in proveedores %}
                                        <option value="{{ proveedor.id_proveedor }}">{{ proveedor.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalNuevoProveedor">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="fecha_factura" class="form-label">Fecha de Factura</label>
                                <input type="date" class="form-control" id="fecha_factura" name="fecha_factura" 
                                       value="{{ today }}" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <label for="observaciones" class="form-label">Observaciones</label>
                                <textarea class="form-control" id="observaciones" name="observaciones" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Productos del Lote -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-boxes text-success"></i> 
                            Productos del Lote
                        </h5>
                        <div>
                            <button type="button" class="btn btn-outline-success me-2" onclick="abrirModalAdministracionCategorias()">
                                <i class="fas fa-cogs"></i> Administrar Categorías
                            </button>
                            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalAgregarProducto">
                                <i class="fas fa-plus"></i> Agregar Producto
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="tablaProductos">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 5%;">#</th>
                                        <th style="width: 20%;">Producto Existente</th>
                                        <th style="width: 10%;">Categoría</th>
                                        <th style="width: 10%;">Subcategoría</th>
                                        <th style="width: 10%;">Marca</th>
                                        <th style="width: 10%;">Versión</th>
                                        <th style="width: 8%;">Pesable</th>
                                        <th style="width: 10%;">Cantidad</th>
                                        <th style="width: 12%;">Precio Compra</th>
                                        <th style="width: 12%;">Precio Venta</th>
                                        <th style="width: 3%;">Acción</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyProductos">
                                    <!-- Las filas se agregarán dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones de Acción -->
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-end gap-2">
                    <a href="{{ url_for('listar_lotes') }}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Crear Lote
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Modal Nuevo Proveedor -->
<div class="modal fade" id="modalNuevoProveedor" tabindex="-1" aria-labelledby="modalNuevoProveedorLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalNuevoProveedorLabel">
                    <i class="fas fa-plus text-primary"></i> Nuevo Proveedor
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formNuevoProveedor">
                    <div class="mb-3">
                        <label for="nombre_proveedor" class="form-label">Nombre del Proveedor *</label>
                        <input type="text" class="form-control" id="nombre_proveedor" name="nombre" required>
                    </div>
                    <div class="mb-3">
                        <label for="telefono_proveedor" class="form-label">Teléfono</label>
                        <input type="text" class="form-control" id="telefono_proveedor" name="telefono">
                    </div>
                    <div class="mb-3">
                        <label for="email_proveedor" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email_proveedor" name="email">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="crearProveedor()">
                    <i class="fas fa-save"></i> Crear Proveedor
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nueva Categoría -->
<div class="modal fade" id="modalNuevaCategoria" tabindex="-1" aria-labelledby="modalNuevaCategoriaLabel" aria-hidden="true" style="z-index: 9999;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalNuevaCategoriaLabel">
                    <i class="fas fa-plus text-success"></i> Nueva Categoría
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formNuevaCategoria">
                    <div class="mb-3">
                        <label for="nombre_categoria" class="form-label">Nombre de la Categoría *</label>
                        <input type="text" class="form-control" id="nombre_categoria" name="nombre" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="crearCategoria()">
                    <i class="fas fa-save"></i> Crear Categoría
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nueva Subcategoría -->
<div class="modal fade" id="modalNuevaSubcategoria" tabindex="-1" aria-labelledby="modalNuevaSubcategoriaLabel" aria-hidden="true" style="z-index: 9999;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalNuevaSubcategoriaLabel">
                    <i class="fas fa-plus text-info"></i> Nueva Subcategoría
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formNuevaSubcategoria">
                    <div class="mb-3">
                        <label for="categoria_subcategoria" class="form-label">Categoría *</label>
                        <select class="form-select" id="categoria_subcategoria" name="categoria_id" required>
                            <option value="">Seleccionar categoría...</option>
                            {% for categoria in categorias %}
                            <option value="{{ categoria.id_categoria }}">{{ categoria.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="nombre_subcategoria" class="form-label">Nombre de la Subcategoría *</label>
                        <input type="text" class="form-control" id="nombre_subcategoria" name="nombre" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-info" onclick="crearSubcategoria()">
                    <i class="fas fa-save"></i> Crear Subcategoría
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nueva Marca -->
<div class="modal fade" id="modalNuevaMarca" tabindex="-1" aria-labelledby="modalNuevaMarcaLabel" aria-hidden="true" style="z-index: 9999;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalNuevaMarcaLabel">
                    <i class="fas fa-plus text-warning"></i> Nueva Marca
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formNuevaMarca">
                    <div class="mb-3">
                        <label for="subcategoria_marca" class="form-label">Subcategoría *</label>
                        <select class="form-select" id="subcategoria_marca" name="subcategoria_id" required>
                            <option value="">Seleccionar subcategoría...</option>
                            {% for subcategoria in subcategorias %}
                            <option value="{{ subcategoria.id_subcategoria }}">{{ subcategoria.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="nombre_marca" class="form-label">Nombre de la Marca *</label>
                        <input type="text" class="form-control" id="nombre_marca" name="nombre" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="crearMarca()">
                    <i class="fas fa-save"></i> Crear Marca
                </button>
            </div>
        </div>
    </div>
</div>

 <!-- Modal Nueva Versión -->
<div class="modal fade" id="modalNuevaVersion" tabindex="-1" aria-labelledby="modalNuevaVersionLabel" aria-hidden="true" style="z-index: 9999;">
    <div class="modal-dialog">
         <div class="modal-content">
             <div class="modal-header">
                 <h5 class="modal-title" id="modalNuevaVersionLabel">
                     <i class="fas fa-plus text-danger"></i> Nueva Versión
                 </h5>
                 <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
             </div>
             <div class="modal-body">
                 <form id="formNuevaVersion">
                                         <div class="mb-3">
                        <label for="marca_version" class="form-label">Marca *</label>
                        <select class="form-select" id="marca_version" name="marca_id" required>
                            <option value="">Seleccionar marca...</option>
                            {% for marca in marcas %}
                            <option value="{{ marca.id_marca }}">{{ marca.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                     <div class="mb-3">
                         <label for="nombre_version" class="form-label">Nombre de la Versión *</label>
                         <input type="text" class="form-control" id="nombre_version" name="nombre" required>
                     </div>
                 </form>
             </div>
             <div class="modal-footer">
                 <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                 <button type="button" class="btn btn-danger" onclick="crearVersion()">
                     <i class="fas fa-save"></i> Crear Versión
                 </button>
             </div>
         </div>
     </div>
 </div>

 <!-- Modal Administración de Categorías -->
 <div class="modal fade" id="modalAdministracionCategorias" tabindex="-1" aria-labelledby="modalAdministracionCategoriasLabel" aria-hidden="true">
     <div class="modal-dialog modal-xl">
         <div class="modal-content">
             <div class="modal-header">
                 <h5 class="modal-title" id="modalAdministracionCategoriasLabel">
                     <i class="fas fa-cogs text-success"></i> Administración de Categorías
                 </h5>
                 <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
             </div>
             <div class="modal-body">
                 <iframe src="{{ url_for('listar_categorias') }}" width="100%" height="500px" frameborder="0"></iframe>
             </div>
             <div class="modal-footer">
                 <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                 <button type="button" class="btn btn-primary" onclick="recargarDatosCategorias()">
                     <i class="fas fa-sync"></i> Actualizar Datos
                 </button>
             </div>
         </div>
     </div>
 </div>

<!-- Modal Agregar Producto -->
<div class="modal fade" id="modalAgregarProducto" tabindex="-1" aria-labelledby="modalAgregarProductoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAgregarProductoLabel">
                    <i class="fas fa-plus text-success"></i> Agregar Producto al Lote
                </h5>
                <div class="ms-auto me-3">
                    <span class="badge bg-success" id="contadorProductos">
                        <i class="fas fa-box"></i> <span id="numeroProductos">0</span> productos agregados
                    </span>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formAgregarProducto">
                    <!-- Paso 1: Tipo de Producto -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-box"></i> Paso 1: Tipo de Producto
                        </h6>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="tipo_producto" id="producto_existente" value="existente" checked onclick="mostrarProductoExistente()">
                            <label class="form-check-label" for="producto_existente">
                                <i class="fas fa-search"></i> Producto Existente
                            </label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="tipo_producto" id="producto_nuevo" value="nuevo" onclick="mostrarProductoNuevo()">
                            <label class="form-check-label" for="producto_nuevo">
                                <i class="fas fa-plus"></i> Producto Nuevo
                            </label>
                        </div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-info" onclick="testFunciones()">
                                <i class="fas fa-bug"></i> Test Funciones
                            </button>
                        </div>
                    </div>

                    <!-- Producto Existente -->
                    <div id="seccion_producto_existente" class="mb-4">
                        <div class="mb-3">
                            <label for="producto_existente_select" class="form-label">
                                <i class="fas fa-search"></i> Seleccionar Producto Existente
                            </label>
                            <select class="form-select" id="producto_existente_select" name="producto_existente">
                                <option value="">Buscar producto...</option>
                                {% for producto in productos_existentes %}
                                <option value="{{ producto.id_producto }}" 
                                        data-categoria="{{ producto.categoria }}"
                                        data-subcategoria="{{ producto.subcategoria }}"
                                        data-marca="{{ producto.marca_nombre }}"
                                        data-version="{{ producto.version }}">
                                    {{ producto.codigo }} - {{ producto.nombre }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Producto Nuevo -->
                    <div id="seccion_producto_nuevo" class="mb-4" style="display: none;">
                        <h6 class="text-success mb-3">
                            <i class="fas fa-cogs"></i> Configuración del Producto
                        </h6>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="categoria_select" class="form-label">
                                    <i class="fas fa-folder"></i> Categoría
                                </label>
                                <div class="input-group">
                                    <select class="form-select" id="categoria_select" name="categoria_id">
                                        <option value="">Seleccionar categoría...</option>
                                        {% for categoria in categorias %}
                                        <option value="{{ categoria.id_categoria }}">{{ categoria.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                    <button type="button" class="btn btn-outline-primary" onclick="abrirModalCategoria()">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="subcategoria_select" class="form-label">
                                    <i class="fas fa-folder-open"></i> Subcategoría
                                </label>
                                <div class="input-group">
                                    <select class="form-select" id="subcategoria_select" name="subcategoria_id">
                                        <option value="">Seleccionar subcategoría...</option>
                                    </select>
                                    <button type="button" class="btn btn-outline-success" onclick="abrirModalSubcategoria()">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="marca_select" class="form-label">
                                    <i class="fas fa-tag"></i> Marca
                                </label>
                                <div class="input-group">
                                    <select class="form-select" id="marca_select" name="marca_id">
                                        <option value="">Seleccionar marca...</option>
                                    </select>
                                    <button type="button" class="btn btn-outline-warning" onclick="abrirModalMarca()">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="version_select" class="form-label">
                                    <i class="fas fa-cog"></i> Versión
                                </label>
                                <div class="input-group">
                                    <select class="form-select" id="version_select" name="version_id">
                                        <option value="">Seleccionar versión...</option>
                                    </select>
                                    <button type="button" class="btn btn-outline-info" onclick="abrirModalVersion()">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Paso 2: Configuración del Producto -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-cogs"></i> Paso 2: Configuración del Producto
                        </h6>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="es_pesable" name="es_pesable">
                                    <label class="form-check-label" for="es_pesable">
                                        <i class="fas fa-weight-hanging"></i> Producto Pesable
                                    </label>
                                </div>
                                <div class="form-text">Marcar si el producto se vende por peso</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="cantidad_producto" class="form-label">
                                    <i class="fas fa-hashtag"></i> Cantidad
                                </label>
                                <input type="number" class="form-control" id="cantidad_producto" name="cantidad" 
                                       min="1" step="1" value="1" required>
                                <div class="form-text" id="unidad_text">unidades</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="codigo_producto" class="form-label">
                                    <i class="fas fa-barcode"></i> Código (Auto-generado)
                                </label>
                                <input type="text" class="form-control" id="codigo_producto" name="codigo" readonly>
                                <div class="form-text">Se generará automáticamente</div>
                            </div>
                        </div>
                    </div>

                    <!-- Paso 3: Precios -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-dollar-sign"></i> Paso 3: Precios
                        </h6>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="precio_compra" class="form-label">
                                    <i class="fas fa-shopping-cart"></i> Precio de Compra
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="precio_compra" name="precio_compra" 
                                           min="0" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="precio_venta" class="form-label">
                                    <i class="fas fa-tag"></i> Precio de Venta
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="precio_venta" name="precio_venta" 
                                           min="0" step="0.01" required>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="agregarProductoAlLote()">
                    <i class="fas fa-plus"></i> Agregar al Lote
                </button>
                <button type="button" class="btn btn-primary" onclick="cerrarModalAgregarProducto()">
                    <i class="fas fa-check"></i> Terminar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Variables globales
let contadorFilas = 0;
let productosAgregados = 0;
const categorias = JSON.parse('{{ categorias | tojson | safe }}');
const subcategorias = JSON.parse('{{ subcategorias | tojson | safe }}');
const marcas = JSON.parse('{{ marcas | tojson | safe }}');
const versiones = JSON.parse('{{ versiones | tojson | safe }}');
const productosExistentes = JSON.parse('{{ productos_existentes | tojson | safe }}');

// Función para agregar una nueva fila de producto
function agregarFilaProducto() {
    contadorFilas++;
    const tbody = document.getElementById('tbodyProductos');
    
    const nuevaFila = `
        <tr id="fila_${contadorFilas}">
            <td>${contadorFilas}</td>
            <td>
                <select class="form-select producto-existente" name="codigo_existente[]" onchange="seleccionarProductoExistente(this, ${contadorFilas})">
                    <option value="">Nuevo producto...</option>
                    ${productosExistentes.map(p => `<option value="${p.id_producto}">${p.codigo} - ${p.nombre}</option>`).join('')}
                </select>
            </td>
            <td>
                <select class="form-select categoria-select" name="categoria_id[]" onchange="cargarSubcategorias(this, ${contadorFilas})">
                    <option value="">Seleccionar...</option>
                    ${categorias.map(c => `<option value="${c.id_categoria}">${c.nombre}</option>`).join('')}
                </select>
            </td>
            <td>
                <select class="form-select subcategoria-select" name="subcategoria_id[]" onchange="cargarMarcas(this, ${contadorFilas})">
                    <option value="">Seleccionar...</option>
                </select>
            </td>
            <td>
                <select class="form-select marca-select" name="marca_id[]" onchange="cargarVersiones(this, ${contadorFilas})">
                    <option value="">Seleccionar...</option>
                </select>
            </td>
            <td>
                <select class="form-select version-select" name="version_id[]">
                    <option value="">Seleccionar...</option>
                </select>
            </td>
            <td>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="es_pesable[]" value="1" onchange="togglePesable(this, ${contadorFilas})">
                    <label class="form-check-label">Pesable</label>
                </div>
            </td>
            <td>
                <input type="number" class="form-control cantidad-input" name="cantidad[]" placeholder="Cant." min="0.001" step="0.001" required>
                <small class="form-text text-muted unidad-text">unidades</small>
            </td>
            <td>
                <input type="number" class="form-control" name="precio_compra[]" placeholder="0.00" step="0.01" min="0" required>
            </td>
            <td>
                <input type="number" class="form-control" name="precio_venta[]" placeholder="0.00" step="0.01" min="0" required>
            </td>
            <td>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="eliminarFila(${contadorFilas})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `;
    
    tbody.insertAdjacentHTML('beforeend', nuevaFila);
}

// Función para cerrar el modal de agregar producto
function cerrarModalAgregarProducto() {
    // Limpiar completamente el formulario
    const form = document.getElementById('formAgregarProducto');
    if (form) {
        form.reset();
    }
    
    // Resetear los selects del modal
    const categoriaSelectModal = document.getElementById('categoria_select');
    const subcategoriaSelectModal = document.getElementById('subcategoria_select');
    const marcaSelectModal = document.getElementById('marca_select');
    const versionSelectModal = document.getElementById('version_select');
    
    if (categoriaSelectModal) categoriaSelectModal.value = '';
    if (subcategoriaSelectModal) {
        subcategoriaSelectModal.innerHTML = '<option value="">Seleccionar subcategoría...</option>';
    }
    if (marcaSelectModal) {
        marcaSelectModal.innerHTML = '<option value="">Seleccionar marca...</option>';
    }
    if (versionSelectModal) {
        versionSelectModal.innerHTML = '<option value="">Seleccionar versión...</option>';
    }
    
    // Resetear checkbox de pesable
    const esPesableCheckbox = document.getElementById('es_pesable');
    if (esPesableCheckbox) {
        esPesableCheckbox.checked = false;
        esPesableCheckbox.dispatchEvent(new Event('change'));
    }
    
    // Cerrar el modal
    bootstrap.Modal.getInstance(document.getElementById('modalAgregarProducto')).hide();
    
    mostrarMensaje('Modal cerrado. Puede continuar creando el lote.', 'info');
}

// Función para eliminar una fila
function eliminarFila(numeroFila) {
    const fila = document.getElementById(`fila_${numeroFila}`);
    if (fila) {
        fila.remove();
    }
}

// Función para seleccionar un producto existente
function seleccionarProductoExistente(select, filaIndex) {
    const fila = document.getElementById(`fila_${filaIndex}`);
    const productoId = select.value;
    
    if (productoId) {
        const producto = productosExistentes.find(p => p.id_producto == productoId);
        if (producto) {
            fila.querySelector('input[name="precio_venta[]"]').value = producto.precio_venta;
            
            // Llenar los selects con los valores del producto
            if (producto.categoria) {
                const categoriaSelect = fila.querySelector('.categoria-select');
                categoriaSelect.value = categorias.find(c => c.nombre === producto.categoria)?.id_categoria || '';
                cargarSubcategorias(categoriaSelect, filaIndex);
            }
        }
    }
}

// Función para cargar subcategorías
function cargarSubcategorias(select, filaIndex) {
    const categoriaId = select.value;
    const fila = document.getElementById(`fila_${filaIndex}`);
    const subcategoriaSelect = fila.querySelector('.subcategoria-select');
    const marcaSelect = fila.querySelector('.marca-select');
    const versionSelect = fila.querySelector('.version-select');
    
    // Limpiar selects dependientes
    subcategoriaSelect.innerHTML = '<option value="">Seleccionar...</option>';
    marcaSelect.innerHTML = '<option value="">Seleccionar...</option>';
    versionSelect.innerHTML = '<option value="">Seleccionar...</option>';
    
    if (categoriaId) {
        const subcategoriasFiltradas = subcategorias.filter(s => s.categoria_id == categoriaId);
        subcategoriasFiltradas.forEach(sub => {
            subcategoriaSelect.innerHTML += `<option value="${sub.id_subcategoria}">${sub.nombre}</option>`;
        });
    }
}

// Función para cargar marcas
function cargarMarcas(select, filaIndex) {
    const subcategoriaId = select.value;
    const fila = document.getElementById(`fila_${filaIndex}`);
    const marcaSelect = fila.querySelector('.marca-select');
    const versionSelect = fila.querySelector('.version-select');
    
    // Limpiar selects dependientes
    marcaSelect.innerHTML = '<option value="">Seleccionar...</option>';
    versionSelect.innerHTML = '<option value="">Seleccionar...</option>';
    
    if (subcategoriaId) {
        const marcasFiltradas = marcas.filter(m => m.subcategoria_id == subcategoriaId);
        marcasFiltradas.forEach(marca => {
            marcaSelect.innerHTML += `<option value="${marca.id_marca}">${marca.nombre}</option>`;
        });
    }
}

// Función para cargar versiones
function cargarVersiones(select, filaIndex) {
    const marcaId = select.value;
    const fila = document.getElementById(`fila_${filaIndex}`);
    const versionSelect = fila.querySelector('.version-select');
    
    // Limpiar select de versiones
    versionSelect.innerHTML = '<option value="">Seleccionar...</option>';
    
    if (marcaId) {
        const versionesFiltradas = versiones.filter(v => v.marca_id == marcaId);
        versionesFiltradas.forEach(version => {
            versionSelect.innerHTML += `<option value="${version.id_version}">${version.nombre}</option>`;
        });
    }
}

// Funciones para abrir modales
function abrirModalCategoria() {
    // Guardar referencia al modal principal
    const modalPrincipal = bootstrap.Modal.getInstance(document.getElementById('modalAgregarProducto'));
    
    // Abrir modal secundario
    const modalCategoria = new bootstrap.Modal(document.getElementById('modalNuevaCategoria'));
    modalCategoria.show();
    
    // Restaurar modal principal cuando se cierre el secundario
    document.getElementById('modalNuevaCategoria').addEventListener('hidden.bs.modal', function() {
        if (modalPrincipal) {
            modalPrincipal.show();
        }
    }, { once: true });
}

function abrirModalSubcategoria() {
    // Guardar referencia al modal principal
    const modalPrincipal = bootstrap.Modal.getInstance(document.getElementById('modalAgregarProducto'));
    
    // Obtener la categoría seleccionada en el modal principal
    const categoriaSelect = document.getElementById('categoria_select');
    const categoriaSeleccionada = categoriaSelect ? categoriaSelect.value : '';
    
    // Abrir modal secundario
    const modalSubcategoria = new bootstrap.Modal(document.getElementById('modalNuevaSubcategoria'));
    modalSubcategoria.show();
    
    // Pre-seleccionar la categoría en el modal de subcategoría
    setTimeout(() => {
        const categoriaSubcategoriaSelect = document.getElementById('categoria_subcategoria');
        if (categoriaSubcategoriaSelect && categoriaSeleccionada) {
            categoriaSubcategoriaSelect.value = categoriaSeleccionada;
        }
    }, 100);
    
    // Restaurar modal principal cuando se cierre el secundario
    document.getElementById('modalNuevaSubcategoria').addEventListener('hidden.bs.modal', function() {
        if (modalPrincipal) {
            modalPrincipal.show();
        }
    }, { once: true });
}

function abrirModalMarca() {
    // Guardar referencia al modal principal
    const modalPrincipal = bootstrap.Modal.getInstance(document.getElementById('modalAgregarProducto'));
    
    // Obtener la subcategoría seleccionada en el modal principal
    const subcategoriaSelect = document.getElementById('subcategoria_select');
    const subcategoriaSeleccionada = subcategoriaSelect ? subcategoriaSelect.value : '';
    
    // Abrir modal secundario
    const modalMarca = new bootstrap.Modal(document.getElementById('modalNuevaMarca'));
    modalMarca.show();
    
    // Pre-seleccionar la subcategoría en el modal de marca
    setTimeout(() => {
        const subcategoriaMarcaSelect = document.getElementById('subcategoria_marca');
        if (subcategoriaMarcaSelect && subcategoriaSeleccionada) {
            subcategoriaMarcaSelect.value = subcategoriaSeleccionada;
        }
    }, 100);
    
    // Restaurar modal principal cuando se cierre el secundario
    document.getElementById('modalNuevaMarca').addEventListener('hidden.bs.modal', function() {
        if (modalPrincipal) {
            modalPrincipal.show();
        }
    }, { once: true });
}

function abrirModalVersion() {
    // Guardar referencia al modal principal
    const modalPrincipal = bootstrap.Modal.getInstance(document.getElementById('modalAgregarProducto'));
    
    // Obtener la marca seleccionada en el modal principal
    const marcaSelect = document.getElementById('marca_select');
    const marcaSeleccionada = marcaSelect ? marcaSelect.value : '';
    
    // Abrir modal secundario
    const modalVersion = new bootstrap.Modal(document.getElementById('modalNuevaVersion'));
    modalVersion.show();
    
    // Pre-seleccionar la marca en el modal de versión
    setTimeout(() => {
        const marcaVersionSelect = document.getElementById('marca_version');
        if (marcaVersionSelect && marcaSeleccionada) {
            // Limpiar opciones existentes (excepto la primera)
            while (marcaVersionSelect.children.length > 1) {
                marcaVersionSelect.removeChild(marcaVersionSelect.lastChild);
            }
            
            // Agregar las marcas filtradas por la subcategoría actual
            const subcategoriaActual = document.getElementById('subcategoria_select').value;
            marcas.forEach(marca => {
                if (marca.subcategoria_id == subcategoriaActual) {
                    const option = new Option(marca.nombre, marca.id_marca);
                    marcaVersionSelect.add(option);
                }
            });
            
            // Seleccionar la marca
            marcaVersionSelect.value = marcaSeleccionada;
        }
    }, 100);
    
    // Restaurar modal principal cuando se cierre el secundario
    document.getElementById('modalNuevaVersion').addEventListener('hidden.bs.modal', function() {
        if (modalPrincipal) {
            modalPrincipal.show();
        }
    }, { once: true });
}

function abrirModalAdministracionCategorias() {
    const modal = new bootstrap.Modal(document.getElementById('modalAdministracionCategorias'));
    modal.show();
}

function recargarDatosCategorias() {
    // Recargar la página para obtener los datos actualizados
    location.reload();
}

// Funciones para crear nuevos elementos
function crearProveedor() {
    const formData = new FormData(document.getElementById('formNuevoProveedor'));
    const data = Object.fromEntries(formData.entries());
    
    fetch('/api/proveedores', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Agregar el nuevo proveedor al select
            const select = document.getElementById('id_proveedor');
            const option = new Option(result.proveedor.nombre, result.proveedor.id_proveedor);
            select.add(option);
            select.value = result.proveedor.id_proveedor;
            
            // Cerrar modal y limpiar formulario
            bootstrap.Modal.getInstance(document.getElementById('modalNuevoProveedor')).hide();
            document.getElementById('formNuevoProveedor').reset();
            
            // Mostrar mensaje de éxito
            mostrarMensaje('Proveedor creado exitosamente', 'success');
        } else {
            mostrarMensaje(result.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarMensaje('Error al crear el proveedor', 'error');
    });
}

function crearCategoria() {
    const formData = new FormData(document.getElementById('formNuevaCategoria'));
    const data = Object.fromEntries(formData.entries());
    
    fetch('/api/categorias', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Agregar la nueva categoría a todos los selects de categoría
            const selects = document.querySelectorAll('.categoria-select');
            selects.forEach(select => {
                const option = new Option(result.categoria.nombre, result.categoria.id_categoria);
                select.add(option);
            });
            
            // Agregar al select del modal de agregar producto
            const categoriaSelectModal = document.getElementById('categoria_select');
            if (categoriaSelectModal) {
                const option = new Option(result.categoria.nombre, result.categoria.id_categoria);
                categoriaSelectModal.add(option);
            }
            
            // También agregar a todos los selects de categoría en la tabla principal
            const categoriaSelects = document.querySelectorAll('.categoria-select');
            categoriaSelects.forEach(select => {
                const option = new Option(result.categoria.nombre, result.categoria.id_categoria);
                select.add(option);
            });
            
            // Agregar a la variable global
            categorias.push(result.categoria);
            
            // Cerrar modal y limpiar formulario
            bootstrap.Modal.getInstance(document.getElementById('modalNuevaCategoria')).hide();
            document.getElementById('formNuevaCategoria').reset();
            
            // Restaurar modal principal
            const modalPrincipal = new bootstrap.Modal(document.getElementById('modalAgregarProducto'));
            modalPrincipal.show();
            
            mostrarMensaje('Categoría creada exitosamente', 'success');
        } else {
            mostrarMensaje(result.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarMensaje('Error al crear la categoría', 'error');
    });
}

function crearSubcategoria() {
    const formData = new FormData(document.getElementById('formNuevaSubcategoria'));
    const data = Object.fromEntries(formData.entries());
    
    fetch('/api/subcategorias', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Agregar la nueva subcategoría a la variable global
            subcategorias.push(result.subcategoria);
            
            // Actualizar los selects de subcategoría de la categoría correspondiente
            const selects = document.querySelectorAll('.subcategoria-select');
            selects.forEach(select => {
                const categoriaSelect = select.closest('tr').querySelector('.categoria-select');
                if (categoriaSelect.value == result.subcategoria.categoria_id) {
                    const option = new Option(result.subcategoria.nombre, result.subcategoria.id_subcategoria);
                    select.add(option);
                }
            });
            
            // Agregar al select del modal de agregar producto
            const subcategoriaSelectModal = document.getElementById('subcategoria_select');
            if (subcategoriaSelectModal) {
                const categoriaSelectModal = document.getElementById('categoria_select');
                if (categoriaSelectModal && categoriaSelectModal.value == result.subcategoria.categoria_id) {
                    const option = new Option(result.subcategoria.nombre, result.subcategoria.id_subcategoria);
                    subcategoriaSelectModal.add(option);
                    subcategoriaSelectModal.value = result.subcategoria.id_subcategoria;
                }
            }
            
            // También agregar a todos los selects de subcategoría en la tabla principal
            const subcategoriaSelects = document.querySelectorAll('.subcategoria-select');
            subcategoriaSelects.forEach(select => {
                const categoriaSelect = select.closest('tr').querySelector('.categoria-select');
                if (categoriaSelect && categoriaSelect.value == result.subcategoria.categoria_id) {
                    const option = new Option(result.subcategoria.nombre, result.subcategoria.id_subcategoria);
                    select.add(option);
                }
            });
            
            // Agregar al select del modal Nueva Marca
            const subcategoriaMarcaSelect = document.getElementById('subcategoria_marca');
            if (subcategoriaMarcaSelect) {
                const option = new Option(result.subcategoria.nombre, result.subcategoria.id_subcategoria);
                subcategoriaMarcaSelect.add(option);
            }
            
            // Cerrar modal y limpiar formulario
            bootstrap.Modal.getInstance(document.getElementById('modalNuevaSubcategoria')).hide();
            document.getElementById('formNuevaSubcategoria').reset();
            
            // Restaurar modal principal
            const modalPrincipal = new bootstrap.Modal(document.getElementById('modalAgregarProducto'));
            modalPrincipal.show();
            
            mostrarMensaje('Subcategoría creada exitosamente', 'success');
        } else {
            mostrarMensaje(result.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarMensaje('Error al crear la subcategoría', 'error');
    });
}

function crearMarca() {
    const formData = new FormData(document.getElementById('formNuevaMarca'));
    const data = Object.fromEntries(formData.entries());
    
    fetch('/api/marcas', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Agregar la nueva marca a la variable global
            marcas.push(result.marca);
            
            // Actualizar los selects de marca de la subcategoría correspondiente
            const selects = document.querySelectorAll('.marca-select');
            selects.forEach(select => {
                const subcategoriaSelect = select.closest('tr').querySelector('.subcategoria-select');
                if (subcategoriaSelect.value == result.marca.subcategoria_id) {
                    const option = new Option(result.marca.nombre, result.marca.id_marca);
                    select.add(option);
                }
            });
            
            // Agregar al select del modal de agregar producto
            const marcaSelectModal = document.getElementById('marca_select');
            if (marcaSelectModal) {
                const subcategoriaSelectModal = document.getElementById('subcategoria_select');
                if (subcategoriaSelectModal && subcategoriaSelectModal.value == result.marca.subcategoria_id) {
                    const option = new Option(result.marca.nombre, result.marca.id_marca);
                    marcaSelectModal.add(option);
                    marcaSelectModal.value = result.marca.id_marca;
                }
            }
            
            // También agregar a todos los selects de marca en la tabla principal
            const marcaSelects = document.querySelectorAll('.marca-select');
            marcaSelects.forEach(select => {
                const subcategoriaSelect = select.closest('tr').querySelector('.subcategoria-select');
                if (subcategoriaSelect && subcategoriaSelect.value == result.marca.subcategoria_id) {
                    const option = new Option(result.marca.nombre, result.marca.id_marca);
                    select.add(option);
                }
            });
            
            // Cerrar modal y limpiar formulario
            bootstrap.Modal.getInstance(document.getElementById('modalNuevaMarca')).hide();
            document.getElementById('formNuevaMarca').reset();
            
            // Restaurar modal principal
            const modalPrincipal = new bootstrap.Modal(document.getElementById('modalAgregarProducto'));
            modalPrincipal.show();
            
            mostrarMensaje('Marca creada exitosamente', 'success');
        } else {
            mostrarMensaje(result.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarMensaje('Error al crear la marca', 'error');
    });
}

function crearVersion() {
    const formData = new FormData(document.getElementById('formNuevaVersion'));
    const data = Object.fromEntries(formData.entries());
    
    fetch('/api/versiones', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Agregar la nueva versión a la variable global
            versiones.push(result.version);
            
            // Actualizar los selects de versión de la marca correspondiente
            const selects = document.querySelectorAll('.version-select');
            selects.forEach(select => {
                const marcaSelect = select.closest('tr').querySelector('.marca-select');
                if (marcaSelect.value == result.version.marca_id) {
                    const option = new Option(result.version.nombre, result.version.id_version);
                    select.add(option);
                }
            });
            
            // Agregar al select del modal de agregar producto
            const versionSelectModal = document.getElementById('version_select');
            if (versionSelectModal) {
                const marcaSelectModal = document.getElementById('marca_select');
                if (marcaSelectModal && marcaSelectModal.value == result.version.marca_id) {
                    const option = new Option(result.version.nombre, result.version.id_version);
                    versionSelectModal.add(option);
                    versionSelectModal.value = result.version.id_version;
                    
                    // Mostrar mensaje de confirmación
                    mostrarMensaje(`Versión "${result.version.nombre}" agregada y seleccionada`, 'success');
                }
            }
            
            // También agregar a todos los selects de versión en la tabla principal
            const versionSelects = document.querySelectorAll('.version-select');
            versionSelects.forEach(select => {
                const marcaSelect = select.closest('tr').querySelector('.marca-select');
                if (marcaSelect && marcaSelect.value == result.version.marca_id) {
                    const option = new Option(result.version.nombre, result.version.id_version);
                    select.add(option);
                }
            });
            
            // Agregar a la variable global
            versiones.push(result.version);
            
            // Cerrar modal y limpiar formulario
            bootstrap.Modal.getInstance(document.getElementById('modalNuevaVersion')).hide();
            document.getElementById('formNuevaVersion').reset();
            
            // Restaurar modal principal
            const modalPrincipal = new bootstrap.Modal(document.getElementById('modalAgregarProducto'));
            modalPrincipal.show();
            
            mostrarMensaje('Versión creada exitosamente', 'success');
        } else {
            mostrarMensaje(result.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarMensaje('Error al crear la versión', 'error');
    });
}

// Función para manejar productos pesables
function togglePesable(checkbox, filaIndex) {
    const fila = document.getElementById(`fila_${filaIndex}`);
    const cantidadInput = fila.querySelector('.cantidad-input');
    const unidadText = fila.querySelector('.unidad-text');
    
    if (checkbox.checked) {
        // Producto pesable
        cantidadInput.min = '0.001';
        cantidadInput.step = '0.001';
        cantidadInput.placeholder = '0.000';
        unidadText.textContent = 'kg';
    } else {
        // Producto no pesable
        cantidadInput.min = '1';
        cantidadInput.step = '1';
        cantidadInput.placeholder = 'Cant.';
        unidadText.textContent = 'unidades';
    }
}

// Función para mostrar mensajes
function mostrarMensaje(mensaje, tipo) {
    // Crear un toast o alert temporal
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${tipo === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    // Remover después de 3 segundos
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}

// Inicializar la primera fila al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== PÁGINA CARGADA ===');
    agregarFilaProducto();
    
    // Configurar eventos del modal de agregar producto
    configurarModalAgregarProducto();
    
    // Debug: verificar elementos
    setTimeout(() => {
        const seccionNuevo = document.getElementById('seccion_producto_nuevo');
        const seccionExistente = document.getElementById('seccion_producto_existente');
        console.log('Debug - Sección nuevo existe:', !!seccionNuevo);
        console.log('Debug - Sección existente existe:', !!seccionExistente);
        if (seccionNuevo) {
            console.log('Debug - Display inicial de sección nuevo:', seccionNuevo.style.display);
        }
    }, 1000);
});

// Configurar eventos del modal de agregar producto
function configurarModalAgregarProducto() {
    // Resetear contador cuando se abre el modal
    document.getElementById('modalAgregarProducto').addEventListener('show.bs.modal', function() {
        productosAgregados = 0;
        const numeroProductosElement = document.getElementById('numeroProductos');
        if (numeroProductosElement) {
            numeroProductosElement.textContent = '0';
        }
        
        // Configurar estado inicial de las secciones
        const productoExistenteRadio = document.getElementById('producto_existente');
        const productoNuevoRadio = document.getElementById('producto_nuevo');
        const seccionExistente = document.getElementById('seccion_producto_existente');
        const seccionNuevo = document.getElementById('seccion_producto_nuevo');
        
        console.log('=== DEBUG MODAL ===');
        console.log('Radio existente encontrado:', !!productoExistenteRadio);
        console.log('Radio nuevo encontrado:', !!productoNuevoRadio);
        console.log('Sección existente encontrada:', !!seccionExistente);
        console.log('Sección nuevo encontrada:', !!seccionNuevo);
        
        if (productoExistenteRadio && productoExistenteRadio.checked) {
            mostrarProductoExistente();
        }
    });
}

// Función para mostrar producto existente
function mostrarProductoExistente() {
    console.log('=== MOSTRAR PRODUCTO EXISTENTE ===');
    const seccionExistente = document.getElementById('seccion_producto_existente');
    const seccionNuevo = document.getElementById('seccion_producto_nuevo');
    
    if (seccionExistente) {
        seccionExistente.style.display = 'block';
        console.log('✅ Sección existente mostrada');
    }
    if (seccionNuevo) {
        seccionNuevo.style.display = 'none';
        console.log('❌ Sección nuevo ocultada');
    }
}

// Función para mostrar producto nuevo
function mostrarProductoNuevo() {
    console.log('=== MOSTRAR PRODUCTO NUEVO ===');
    
    const seccionExistente = document.getElementById('seccion_producto_existente');
    const seccionNuevo = document.getElementById('seccion_producto_nuevo');
    
    console.log('Sección existente encontrada:', !!seccionExistente);
    console.log('Sección nuevo encontrada:', !!seccionNuevo);
    
    if (seccionExistente) {
        seccionExistente.style.display = 'none';
        console.log('❌ Sección existente ocultada');
    }
    if (seccionNuevo) {
        seccionNuevo.style.display = 'block';
        console.log('✅ Sección nuevo mostrada');
    } else {
        console.error('ERROR: No se encontró la sección de producto nuevo');
    }
}
    
// Función de test para debug manual
function testToggleSecciones() {
    console.log('=== TEST MANUAL ===');
    const seccionNuevo = document.getElementById('seccion_producto_nuevo');
    const seccionExistente = document.getElementById('seccion_producto_existente');
    
    console.log('Sección nuevo:', seccionNuevo);
    console.log('Sección existente:', seccionExistente);
    
    if (seccionNuevo) {
        console.log('Display actual de sección nuevo:', seccionNuevo.style.display);
        seccionNuevo.style.display = 'block';
        console.log('Display después de cambiar a block:', seccionNuevo.style.display);
    }
    
    if (seccionExistente) {
        seccionExistente.style.display = 'none';
    }
}

// Función de test específica para producto nuevo
function testProductoNuevo() {
    console.log('=== TEST PRODUCTO NUEVO ===');
    mostrarProductoNuevo();
}

// Función de test simple para verificar que las funciones están disponibles
function testFunciones() {
    console.log('=== TEST FUNCIONES ===');
    console.log('mostrarProductoExistente disponible:', typeof mostrarProductoExistente);
    console.log('mostrarProductoNuevo disponible:', typeof mostrarProductoNuevo);
    
    if (typeof mostrarProductoNuevo === 'function') {
        console.log('✅ Función mostrarProductoNuevo está disponible');
        mostrarProductoNuevo();
    } else {
        console.error('❌ Función mostrarProductoNuevo NO está disponible');
    }
}

// Manejar producto pesable
    document.getElementById('es_pesable').addEventListener('change', function() {
        const cantidadInput = document.getElementById('cantidad_producto');
        const unidadText = document.getElementById('unidad_text');
        
        if (this.checked) {
            cantidadInput.min = '0.001';
            cantidadInput.step = '0.001';
            cantidadInput.placeholder = '0.000';
            unidadText.textContent = 'kg';
        } else {
            cantidadInput.min = '1';
            cantidadInput.step = '1';
            cantidadInput.placeholder = 'Cant.';
            unidadText.textContent = 'unidades';
        }
    });
    
    // Cargar subcategorías cuando se selecciona categoría
    document.getElementById('categoria_select').addEventListener('change', function() {
        cargarSubcategoriasModal(this.value);
    });
    
    // Cargar marcas cuando se selecciona subcategoría
    document.getElementById('subcategoria_select').addEventListener('change', function() {
        cargarMarcasModal(this.value);
    });
    
    // Cargar versiones cuando se selecciona marca
    document.getElementById('marca_select').addEventListener('change', function() {
        cargarVersionesModal(this.value);
    });
}

// Cargar subcategorías en el modal
function cargarSubcategoriasModal(categoriaId) {
    const select = document.getElementById('subcategoria_select');
    select.innerHTML = '<option value="">Seleccionar subcategoría...</option>';
    
    if (categoriaId) {
        const subcategoriasFiltradas = subcategorias.filter(s => s.categoria_id == categoriaId);
        subcategoriasFiltradas.forEach(sub => {
            const option = new Option(sub.nombre, sub.id_subcategoria);
            select.add(option);
        });
    }
}

// Cargar marcas en el modal
function cargarMarcasModal(subcategoriaId) {
    const select = document.getElementById('marca_select');
    select.innerHTML = '<option value="">Seleccionar marca...</option>';
    
    if (subcategoriaId) {
        const marcasFiltradas = marcas.filter(m => m.subcategoria_id == subcategoriaId);
        marcasFiltradas.forEach(marca => {
            const option = new Option(marca.nombre, marca.id_marca);
            select.add(option);
        });
    }
}

// Cargar versiones en el modal
function cargarVersionesModal(marcaId) {
    const select = document.getElementById('version_select');
    select.innerHTML = '<option value="">Seleccionar versión...</option>';
    
    if (marcaId) {
        const versionesFiltradas = versiones.filter(v => v.marca_id == marcaId);
        versionesFiltradas.forEach(version => {
            const option = new Option(version.nombre, version.id_version);
            select.add(option);
        });
    }
}

// Agregar producto al lote desde el modal
function agregarProductoAlLote() {
    const form = document.getElementById('formAgregarProducto');
    const formData = new FormData(form);
    
    // Validar formulario
    if (!formData.get('cantidad') || !formData.get('precio_compra') || !formData.get('precio_venta')) {
        mostrarMensaje('Por favor complete todos los campos requeridos', 'error');
        return;
    }
    
    // Crear objeto del producto
    const producto = {
        tipo: formData.get('tipo_producto'),
        cantidad: formData.get('cantidad'),
        precio_compra: formData.get('precio_compra'),
        precio_venta: formData.get('precio_venta'),
        es_pesable: formData.get('es_pesable') ? 1 : 0
    };
    
    if (producto.tipo === 'existente') {
        producto.producto_existente = formData.get('producto_existente');
        if (!producto.producto_existente) {
            mostrarMensaje('Por favor seleccione un producto existente', 'error');
            return;
        }
    } else {
        producto.categoria_id = formData.get('categoria_id');
        producto.subcategoria_id = formData.get('subcategoria_id');
        producto.marca_id = formData.get('marca_id');
        producto.version_id = formData.get('version_id');
    }
    
    // Agregar a la tabla (simular la función original)
    agregarFilaProductoDesdeModal(producto);
    
    // Incrementar contador de productos agregados
    productosAgregados++;
    
    // Actualizar contador visual
    const numeroProductosElement = document.getElementById('numeroProductos');
    if (numeroProductosElement) {
        numeroProductosElement.textContent = productosAgregados;
    }
    
    // NO cerrar el modal, solo limpiar el formulario para agregar más productos
    form.reset();
    document.getElementById('seccion_producto_nuevo').style.display = 'none';
    document.getElementById('seccion_producto_existente').style.display = 'block';
    
    // Resetear los selects del modal
    const categoriaSelectModal = document.getElementById('categoria_select');
    const subcategoriaSelectModal = document.getElementById('subcategoria_select');
    const marcaSelectModal = document.getElementById('marca_select');
    const versionSelectModal = document.getElementById('version_select');
    
    if (categoriaSelectModal) categoriaSelectModal.value = '';
    if (subcategoriaSelectModal) {
        subcategoriaSelectModal.innerHTML = '<option value="">Seleccionar subcategoría...</option>';
    }
    if (marcaSelectModal) {
        marcaSelectModal.innerHTML = '<option value="">Seleccionar marca...</option>';
    }
    if (versionSelectModal) {
        versionSelectModal.innerHTML = '<option value="">Seleccionar versión...</option>';
    }
    
    // Resetear checkbox de pesable
    const esPesableCheckbox = document.getElementById('es_pesable');
    if (esPesableCheckbox) {
        esPesableCheckbox.checked = false;
        // Trigger el evento change para resetear la cantidad
        esPesableCheckbox.dispatchEvent(new Event('change'));
    }
    
    mostrarMensaje(`Producto agregado al lote correctamente (${productosAgregados} productos agregados)`, 'success');
    
    // NO cerrar el modal, solo limpiar el formulario para agregar más productos
    // El modal se mantiene abierto para agregar múltiples productos rápidamente
    
    // Limpiar solo los campos de datos del producto, manteniendo las selecciones de categoría/marca
    const cantidadInput = document.getElementById('cantidad');
    const precioCompraInput = document.getElementById('precio_compra');
    const precioVentaInput = document.getElementById('precio_venta');
    const esPesableCheckbox = document.getElementById('es_pesable');
    
    if (cantidadInput) cantidadInput.value = '';
    if (precioCompraInput) precioCompraInput.value = '';
    if (precioVentaInput) precioVentaInput.value = '';
    if (esPesableCheckbox) {
        esPesableCheckbox.checked = false;
        esPesableCheckbox.dispatchEvent(new Event('change'));
    }
    
    // Hacer scroll a la tabla para mostrar el nuevo producto
    setTimeout(() => {
        const tabla = document.getElementById('tbodyProductos');
        if (tabla) {
            tabla.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }
    }, 500);
}

// Agregar fila de producto desde el modal
function agregarFilaProductoDesdeModal(producto) {
    contadorFilas++;
    const tbody = document.getElementById('tbodyProductos');
    
    let nuevaFila = `
        <tr id="fila_${contadorFilas}">
            <td>${contadorFilas}</td>
            <td>
                <select class="form-select producto-existente" name="codigo_existente[]">
                    <option value="">Nuevo producto...</option>
                    ${productosExistentes.map(p => `<option value="${p.id_producto}" ${producto.tipo === 'existente' && producto.producto_existente == p.id_producto ? 'selected' : ''}>${p.codigo} - ${p.nombre}</option>`).join('')}
                </select>
            </td>
            <td>
                <select class="form-select categoria-select" name="categoria_id[]">
                    <option value="">Seleccionar...</option>
                    ${categorias.map(c => `<option value="${c.id_categoria}" ${producto.categoria_id == c.id_categoria ? 'selected' : ''}>${c.nombre}</option>`).join('')}
                </select>
            </td>
            <td>
                <select class="form-select subcategoria-select" name="subcategoria_id[]">
                    <option value="">Seleccionar...</option>
                </select>
            </td>
            <td>
                <select class="form-select marca-select" name="marca_id[]">
                    <option value="">Seleccionar...</option>
                </select>
            </td>
            <td>
                <select class="form-select version-select" name="version_id[]">
                    <option value="">Seleccionar...</option>
                </select>
            </td>
            <td>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="es_pesable[]" ${producto.es_pesable ? 'checked' : ''}>
                </div>
            </td>
            <td>
                <input type="number" class="form-control cantidad-input" name="cantidad[]" 
                       value="${producto.cantidad}" min="${producto.es_pesable ? '0.001' : '1'}" 
                       step="${producto.es_pesable ? '0.001' : '1'}" required>
                <small class="text-muted unidad-text">${producto.es_pesable ? 'kg' : 'unidades'}</small>
            </td>
            <td>
                <input type="number" class="form-control" name="precio_compra[]" 
                       value="${producto.precio_compra}" min="0" step="0.01" required>
            </td>
            <td>
                <input type="number" class="form-control" name="precio_venta[]" 
                       value="${producto.precio_venta}" min="0" step="0.01" required>
            </td>
            <td>
                <button type="button" class="btn btn-danger btn-sm" onclick="eliminarFila(${contadorFilas})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `;
    
    tbody.insertAdjacentHTML('beforeend', nuevaFila);
    
    // Configurar eventos para la nueva fila
    const nuevaFilaElement = document.getElementById(`fila_${contadorFilas}`);
    if (nuevaFilaElement) {
        // Configurar evento para categoría
        const categoriaSelect = nuevaFilaElement.querySelector('.categoria-select');
        if (categoriaSelect) {
            categoriaSelect.addEventListener('change', function() {
                const fila = this.closest('tr');
                cargarSubcategorias(fila, this.value);
            });
            
            // Si ya hay una categoría seleccionada, cargar subcategorías
            if (producto.categoria_id) {
                cargarSubcategorias(nuevaFilaElement, producto.categoria_id);
            }
        }
        
        // Configurar evento para subcategoría
        const subcategoriaSelect = nuevaFilaElement.querySelector('.subcategoria-select');
        if (subcategoriaSelect) {
            subcategoriaSelect.addEventListener('change', function() {
                const fila = this.closest('tr');
                cargarMarcas(fila, this.value);
            });
            
            // Si ya hay una subcategoría seleccionada, cargar marcas
            if (producto.subcategoria_id) {
                setTimeout(() => {
                    cargarMarcas(nuevaFilaElement, producto.subcategoria_id);
                }, 100);
            }
        }
        
        // Configurar evento para marca
        const marcaSelect = nuevaFilaElement.querySelector('.marca-select');
        if (marcaSelect) {
            marcaSelect.addEventListener('change', function() {
                const fila = this.closest('tr');
                cargarVersiones(fila, this.value);
            });
            
            // Si ya hay una marca seleccionada, cargar versiones
            if (producto.marca_id) {
                setTimeout(() => {
                    cargarVersiones(nuevaFilaElement, producto.marca_id);
                }, 200);
            }
        }
    }
}

</script>

{% endblock %}