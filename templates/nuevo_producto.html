{% extends "base.html" %}

{% block title %}Nuevo Producto - Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3">Nuevo Producto</h1>
                <a href="{{ url_for('admin') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>
            </div>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Información del Producto</h6>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <!-- Información básica -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="codigo" class="form-label">Código del Producto *</label>
                                    <input type="text" class="form-control" id="codigo" name="codigo" required>
                                    <div class="form-text">Código único para identificar el producto</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="nombre" class="form-label">Nombre del Producto *</label>
                                    <input type="text" class="form-control" id="nombre" name="nombre" required>
                                </div>
                            </div>
                        </div>

                        <!-- Categorización -->
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="categoria_id" class="form-label">Categoría *</label>
                                    <select class="form-select" id="categoria_id" name="categoria_id" required>
                                        <option value="">Seleccionar categoría</option>
                                        {% for categoria in categorias %}
                                        <option value="{{ categoria.id_categoria }}">{{ categoria.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="subcategoria_id" class="form-label">Subcategoría</label>
                                    <select class="form-select" id="subcategoria_id" name="subcategoria_id">
                                        <option value="">Seleccionar subcategoría</option>
                                        {% for subcategoria in subcategorias %}
                                        <option value="{{ subcategoria.id_subcategoria }}">{{ subcategoria.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="marca_id" class="form-label">Marca</label>
                                    <select class="form-select" id="marca_id" name="marca_id">
                                        <option value="">Seleccionar marca</option>
                                        {% for marca in marcas %}
                                        <option value="{{ marca.id_marca }}">{{ marca.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="version_id" class="form-label">Versión</label>
                                    <select class="form-select" id="version_id" name="version_id">
                                        <option value="">Seleccionar versión</option>
                                        {% for version in versiones %}
                                        <option value="{{ version.id_version }}">{{ version.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Precios -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="precio_compra" class="form-label">Precio de Compra</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" step="0.01" min="0" class="form-control" id="precio_compra" name="precio_compra" value="0">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="precio_venta" class="form-label">Precio de Venta *</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" step="0.01" min="0" class="form-control" id="precio_venta" name="precio_venta" required>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tipo de producto y stock -->
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Tipo de Producto</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="es_pesable" id="tipo_unidad" value="0" checked>
                                        <label class="form-check-label" for="tipo_unidad">
                                            Producto por Unidad
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="es_pesable" id="tipo_pesable" value="1">
                                        <label class="form-check-label" for="tipo_pesable">
                                            Producto Pesable
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="unidad_medida" class="form-label">Unidad de Medida</label>
                                    <select class="form-select" id="unidad_medida" name="unidad_medida">
                                        <option value="unidad">Unidad</option>
                                        <option value="kg">Kilogramo (kg)</option>
                                        <option value="g">Gramo (g)</option>
                                        <option value="l">Litro (l)</option>
                                        <option value="ml">Mililitro (ml)</option>
                                        <option value="m">Metro (m)</option>
                                        <option value="cm">Centímetro (cm)</option>
                                        <option value="lb">Libra (lb)</option>
                                        <option value="oz">Onza (oz)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="stock" class="form-label">Stock Inicial</label>
                                    <input type="number" step="0.001" min="0" class="form-control" id="stock" name="stock" value="0">
                                    <div class="form-text">Cantidad inicial en inventario</div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('admin') }}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Crear Producto
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Actualizar unidad de medida según el tipo de producto
document.addEventListener('DOMContentLoaded', function() {
    const tipoUnidad = document.getElementById('tipo_unidad');
    const tipoPesable = document.getElementById('tipo_pesable');
    const unidadMedida = document.getElementById('unidad_medida');

    function actualizarUnidadMedida() {
        if (tipoPesable.checked) {
            // Mostrar opciones de unidades pesables
            unidadMedida.innerHTML = `
                <option value="kg">Kilogramo (kg)</option>
                <option value="g">Gramo (g)</option>
                <option value="l">Litro (l)</option>
                <option value="ml">Mililitro (ml)</option>
                <option value="m">Metro (m)</option>
                <option value="cm">Centímetro (cm)</option>
                <option value="lb">Libra (lb)</option>
                <option value="oz">Onza (oz)</option>
            `;
        } else {
            // Mostrar solo unidad
            unidadMedida.innerHTML = '<option value="unidad">Unidad</option>';
        }
    }

    tipoUnidad.addEventListener('change', actualizarUnidadMedida);
    tipoPesable.addEventListener('change', actualizarUnidadMedida);

    // Inicializar
    actualizarUnidadMedida();
});

// Filtros dependientes para categorías
document.addEventListener('DOMContentLoaded', function() {
    const categoriaSelect = document.getElementById('categoria_id');
    const subcategoriaSelect = document.getElementById('subcategoria_id');
    const marcaSelect = document.getElementById('marca_id');
    const versionSelect = document.getElementById('version_id');

    // Datos de las relaciones
    const subcategoriasData = {{ subcategorias | tojson | safe }};
    const marcasData = {{ marcas | tojson | safe }};
    const versionesData = {{ versiones | tojson | safe }};

    function actualizarSubcategorias() {
        const categoriaId = categoriaSelect.value;
        subcategoriaSelect.innerHTML = '<option value="">Seleccionar subcategoría</option>';
        
        if (categoriaId) {
            const subcategoriasFiltradas = subcategoriasData.filter(s => s.categoria_id == categoriaId);
            subcategoriasFiltradas.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub.id_subcategoria;
                option.textContent = sub.nombre;
                subcategoriaSelect.appendChild(option);
            });
        }
    }

    function actualizarMarcas() {
        const subcategoriaId = subcategoriaSelect.value;
        marcaSelect.innerHTML = '<option value="">Seleccionar marca</option>';
        
        if (subcategoriaId) {
            const marcasFiltradas = marcasData.filter(m => m.subcategoria_id == subcategoriaId);
            marcasFiltradas.forEach(marca => {
                const option = document.createElement('option');
                option.value = marca.id_marca;
                option.textContent = marca.nombre;
                marcaSelect.appendChild(option);
            });
        }
    }

    function actualizarVersiones() {
        const marcaId = marcaSelect.value;
        versionSelect.innerHTML = '<option value="">Seleccionar versión</option>';
        
        if (marcaId) {
            const versionesFiltradas = versionesData.filter(v => v.marca_id == marcaId);
            versionesFiltradas.forEach(version => {
                const option = document.createElement('option');
                option.value = version.id_version;
                option.textContent = version.nombre;
                versionSelect.appendChild(option);
            });
        }
    }

    categoriaSelect.addEventListener('change', function() {
        actualizarSubcategorias();
        actualizarMarcas();
        actualizarVersiones();
    });

    subcategoriaSelect.addEventListener('change', function() {
        actualizarMarcas();
        actualizarVersiones();
    });

    marcaSelect.addEventListener('change', function() {
        actualizarVersiones();
    });
});
</script>
{% endblock %}